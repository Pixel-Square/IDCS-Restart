<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OBE • Mark Entry • {{ subject.code }}</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; margin: 24px; color: #0f172a; }
    .muted { color: #64748b; }
    .tabs { display: flex; flex-wrap: wrap; gap: 8px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; margin-bottom: 16px; }
    .tab { display: inline-block; padding: 8px 12px; border-radius: 8px 8px 0 0; text-decoration: none; color: #334155; }
    .tab:hover { color: #0f172a; background: #f1f5f9; }
    .tab.active { color: #1d4ed8; border-bottom: 2px solid #2563eb; border-radius: 0; padding-bottom: 6px; }
    .card { border: 1px solid #e2e8f0; border-radius: 10px; padding: 16px; background: white; }
    .card-header { position: sticky; top: 18px; background: white; z-index: 20; padding-bottom: 6px; margin-bottom: 6px; }
    .btn { display: inline-block; padding: 8px 12px; border-radius: 8px; border: 1px solid #cbd5e1; background: #0ea5e9; color: white; text-decoration: none; cursor: pointer; }
    .btn:hover { filter: brightness(0.97); }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #e2e8f0; text-align: left; padding: 10px 8px; font-size: 14px; }
    th { font-size: 12px; text-transform: uppercase; letter-spacing: .04em; color: #475569; }
    input[type="number"] { width: 120px; padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 8px; }
    .success { background: #ecfdf5; border: 1px solid #10b98133; color: #065f46; padding: 10px 12px; border-radius: 10px; margin-bottom: 12px; }
  </style>
</head>
<body>
  <h2 style="margin: 0 0 6px;">Mark Entry</h2>
  <div class="muted" style="margin-bottom: 14px;">Subject: <strong>{{ subject.code }}</strong> — {{ subject.name }}</div>

  <div class="tabs">
    <a class="tab {% if tab == 'dashboard' %}active{% endif %}" href="?tab=dashboard">Dashboard</a>
    <a class="tab {% if tab == 'ssa1' %}active{% endif %}" href="?tab=ssa1">SSA1</a>
    <a class="tab {% if tab == 'formative1' %}active{% endif %}" href="?tab=formative1">Formative 1</a>
    <a class="tab {% if tab == 'lca' %}active{% endif %}" href="?tab=lca">LCA Instructions</a>
    <a class="tab {% if tab == 'cia1' %}active{% endif %}" href="?tab=cia1">CIA1</a>
    <a class="tab {% if tab == 'ssa2' %}active{% endif %}" href="?tab=ssa2">SSA2</a>
    <a class="tab {% if tab == 'cia2' %}active{% endif %}" href="?tab=cia2">CIA2</a>
    <a class="tab {% if tab == 'model' %}active{% endif %}" href="?tab=model">MODEL</a>
  </div>

  {% if saved %}
    <div class="success">CIA1 marks saved.</div>
  {% endif %}

  {% if errors %}
    <div style="background:#fef2f2;border:1px solid #ef444433;color:#991b1b;padding:10px 12px;border-radius:10px;margin-bottom:12px;">
      <div style="font-weight:600;margin-bottom:6px;">Please fix these inputs:</div>
      <ul style="margin:0;padding-left:18px;">
        {% for e in errors %}
          <li style="margin:2px 0;">{{ e }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if tab == 'dashboard' %}
    <div class="card">
      <h4 style="margin: 0 0 8px;">Dashboard</h4>
      <div class="muted" style="margin-bottom: 12px;">Quick overview and students list for this course</div>
      {% include 'OBE/partials/students_table.html' %}
    </div>
  {% elif tab == 'ssa1' %}
    <div class="card">
      <div class="card-header" style="display:flex;align-items:baseline;justify-content:space-between;gap:12px;margin-bottom:6px;">
        <div>
          <h4 style="margin: 0 0 8px;">SSA1</h4>
          <div class="muted" style="margin-bottom: 0;">Students filtered by subject department / year / section</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="save-draft-btn" class="btn" style="background:#10b981;border-color:transparent;">Save Draft</button>
          <button id="refresh-btn" class="btn" style="background:#fff;color:#0f172a;border:1px solid #cbd5e1;">Refresh</button>
          <button id="publish-btn" class="btn" style="background:#0369a1;">Publish</button>
        </div>
      </div>
      {% include 'OBE/partials/students_table.html' %}
    </div>
  {% elif tab == 'formative1' %}
    <div class="card">
      <div class="card-header" style="display:flex;align-items:baseline;justify-content:space-between;gap:12px;margin-bottom:6px;">
        <div>
          <h4 style="margin: 0 0 8px;">Formative 1</h4>
          <div class="muted" style="margin-bottom: 0;">Mark entry UI (placeholder)</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="save-draft-btn" class="btn" style="background:#10b981;border-color:transparent;">Save Draft</button>
          <button id="refresh-btn" class="btn" style="background:#fff;color:#0f172a;border:1px solid #cbd5e1;">Refresh</button>
          <button id="publish-btn" class="btn" style="background:#0369a1;">Publish</button>
        </div>
      </div>
      {% include 'OBE/partials/students_table.html' %}
    </div>
  {% elif tab == 'cia1' %}
    <div class="card">
      <div class="card-header" style="display:flex;align-items:baseline;justify-content:space-between;gap:12px;margin-bottom:6px;">
        <div>
          <h4 style="margin: 0 0 8px;">CIA1</h4>
          <div class="muted" style="margin-bottom: 0;">Students filtered by subject department / year / section</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="save-draft-btn" type="button" class="btn" style="background:#10b981;border-color:transparent;">Save Draft</button>
          <button id="refresh-btn" type="button" class="btn" style="background:#fff;color:#0f172a;border:1px solid #cbd5e1;">Refresh</button>
          <button id="publish-btn" type="button" class="btn" style="background:#0369a1;">Publish</button>
        </div>
      </div>

      <form id="cia1-form" method="post" action="?tab=cia1">
        {% csrf_token %}
        <table>
          <thead>
            <tr>
              <th style="width: 160px;">Reg No</th>
              <th>Student</th>
              <th style="width: 160px;">CIA1 Mark</th>
            </tr>
          </thead>
          <tbody>
            {% for row in cia1_rows %}
              <tr>
                <td>{{ row.student.reg_no }}</td>
                <td>{{ row.student.user.get_full_name|default:row.student.user.username }}</td>
                <td>
                  <input
                    type="number"
                    name="mark_{{ row.student.id }}"
                    step="0.01"
                    min="0"
                    value="{% if row.mark != None %}{{ row.mark }}{% endif %}"
                    placeholder="0"
                  />
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="3" class="muted">No students found.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <div style="margin-top: 14px; display: flex; gap: 10px; align-items: center;">
          <button class="btn" type="submit">Save CIA1</button>
          <span class="muted" style="font-size: 12px;">Blank inputs will clear stored marks.</span>
        </div>
      </form>
    </div>
  {% elif tab == 'ssa2' %}
    <div class="card">
      <div class="card-header" style="display:flex;align-items:baseline;justify-content:space-between;gap:12px;margin-bottom:6px;">
        <div>
          <h4 style="margin: 0 0 8px;">SSA2</h4>
          <div class="muted" style="margin-bottom: 0;">SSA2 mark entry UI (placeholder)</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="save-draft-btn" class="btn" style="background:#10b981;border-color:transparent;">Save Draft</button>
          <button id="refresh-btn" class="btn" style="background:#fff;color:#0f172a;border:1px solid #cbd5e1;">Refresh</button>
          <button id="publish-btn" class="btn" style="background:#0369a1;">Publish</button>
        </div>
      </div>
      <div style="margin-top:6px">{% include 'OBE/partials/students_table.html' %}</div>
    </div>
  {% elif tab == 'cia2' %}
    <div class="card">
      <div class="card-header" style="display:flex;align-items:baseline;justify-content:space-between;gap:12px;margin-bottom:6px;">
        <div>
          <h4 style="margin: 0 0 8px;">CIA2</h4>
          <div class="muted" style="margin-bottom: 0;">CIA2 mark entry UI (placeholder)</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="save-draft-btn" class="btn" style="background:#10b981;border-color:transparent;">Save Draft</button>
          <button id="refresh-btn" class="btn" style="background:#fff;color:#0f172a;border:1px solid #cbd5e1;">Refresh</button>
          <button id="publish-btn" class="btn" style="background:#0369a1;">Publish</button>
        </div>
      </div>
      <div style="margin-top:6px">{% include 'OBE/partials/students_table.html' %}</div>
    </div>
  {% elif tab == 'model' %}
    <div class="card">
      <div style="display:flex;align-items:baseline;justify-content:space-between;gap:12px;margin-bottom:6px;">
        <div>
          <h4 style="margin: 0 0 8px;">MODEL</h4>
          <div class="muted" style="margin-bottom: 0;">Model Exam mark entry UI (placeholder)</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="save-draft-btn" class="btn" style="background:#10b981;border-color:transparent;">Save Draft</button>
          <button id="refresh-btn" class="btn" style="background:#fff;color:#0f172a;border:1px solid #cbd5e1;">Refresh</button>
          <button id="publish-btn" class="btn" style="background:#0369a1;">Publish</button>
        </div>
      </div>
      <div style="margin-top:6px">{% include 'OBE/partials/students_table.html' %}</div>
    </div>
  {% elif tab == 'lca' %}
    <div class="card">
      <h4 style="margin: 0 0 8px;">LCA Instructions</h4>
      <div class="muted" style="margin-bottom: 12px;">Learner Centric Approach guidance and planning matrix for this subject.</div>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <div style="flex:1;min-width:260px;border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#fff;">
          <img src="/static/obe/lca-1.png" alt="LCA part 1" style="width:100%;display:block;" onerror="this.style.display='none'" />
          <strong>Step 1 — Learner Profile</strong>
          <p class="muted">Identify learner profile (L1–L3) and map instruction levels.</p>
        </div>
        <div style="flex:1;min-width:260px;border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#fff;">
          <img src="/static/obe/lca-2.png" alt="LCA part 2" style="width:100%;display:block;" onerror="this.style.display='none'" />
          <strong>Step 2 — IL Mapping</strong>
          <p class="muted">Use IL tables to determine instruction levels and assessment distribution.</p>
        </div>
      </div>
    </div>
  {% else %}
    <div class="card">
      <h4 style="margin: 0 0 8px;">Unknown tab</h4>
      <div class="muted">Select a tab above.</div>
    </div>
  {% endif %}
</body>
</html>

<script>
// Minimal JS to handle publish/save-draft/refresh for SSA1/CIA1/Formative1 where applicable.
function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}

function qsAll(sel) { return Array.from(document.querySelectorAll(sel)); }

async function checkPublishAllowed(assessment) {
  try {
    const res = await fetch(`/api/obe/publish-window/${encodeURIComponent(assessment)}/${encodeURIComponent('{{ subject.code }}')}`);
    if (!res.ok) return false;
    const j = await res.json();
    return Boolean(j.publish_allowed);
  } catch (e) {
    return false;
  }
}

function collectMarksRows() {
  const rows = [];
  qsAll('input[name^="mark_"]').forEach(inp => {
    const m = inp.name.match(/^mark_(\d+)$/);
    if (!m) return;
    const sid = parseInt(m[1], 10);
    const val = inp.value === '' ? null : inp.value;
    rows.push({ studentId: sid, total: val });
  });
  return rows;
}

async function publishAssessment(assessment) {
  const btn = document.getElementById('publish-btn');
  if (!btn) return;
  btn.disabled = true;
  const rows = collectMarksRows();
  const payload = { data: { rows } };
  try {
    // Map assessment to the correct publish endpoint. CIA endpoints use "-publish-sheet".
    const endpointBase = (String(assessment || '').toLowerCase().startsWith('cia')) ? `${assessment}-publish-sheet` : `${assessment}-publish`;
    const url = `/api/obe/${encodeURIComponent(endpointBase)}/${encodeURIComponent('{{ subject.code }}')}`;
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
      body: JSON.stringify(payload),
    });
    if (res.ok) {
      window.location = window.location.pathname + '?tab=' + encodeURIComponent(assessment) + '&saved=1';
      return;
    }
    const text = await res.text();
    alert('Publish failed: ' + (text || res.statusText));
  } catch (e) {
    alert('Publish error: ' + e);
  } finally {
    btn.disabled = false;
  }
}

function saveDraft(assessment) {
  const btn = document.getElementById('save-draft-btn');
  if (!btn) return;
  btn.disabled = true;
  const rows = collectMarksRows();
  const data = { rows };
  fetch(`/api/obe/draft/${encodeURIComponent(assessment)}/${encodeURIComponent('{{ subject.code }}')}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
    body: JSON.stringify({ data }),
  }).then(r => r.ok ? window.location.reload() : r.text().then(t => alert('Save draft failed: ' + t))).catch(e => alert('Save draft error: ' + e)).finally(() => { btn.disabled = false; });
}

document.addEventListener('DOMContentLoaded', async () => {
  const pubBtn = document.getElementById('publish-btn');
  const saveBtn = document.getElementById('save-draft-btn');
  const refBtn = document.getElementById('refresh-btn');
  if (!pubBtn && !saveBtn && !refBtn) return;
  const assessment = (new URLSearchParams(window.location.search)).get('tab') || '{{ tab }}';
  if (refBtn) refBtn.addEventListener('click', () => window.location.reload());
  if (saveBtn) saveBtn.addEventListener('click', () => saveDraft(assessment));
  if (pubBtn) {
    const allowed = await checkPublishAllowed(assessment);
    if (!allowed) {
      pubBtn.disabled = true;
      pubBtn.title = 'Publishing is not allowed for you at this time.';
    }
    pubBtn.addEventListener('click', () => {
      if (!confirm('Publish marks now? This action will lock the marks.')) return;
      publishAssessment(assessment);
    });
  }
});
</script>
